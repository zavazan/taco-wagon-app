name: Terraform CD

on:
  pull_request:
    branches:
      - main
    types:
      - closed

permissions:
  contents: read
  actions: read

env:
  TF_LOG: INFO
  TF_INPUT: false
  TF_VERSION: ${{ vars.TF_VERSION }}

jobs:
  # Get the workflow run ID from the CI workflow for artifact retrieval
  get-run-id:
    name: Get CI Run ID
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.get-run.outputs.run_id }}
    steps:
      - name: Get CI Workflow Run ID
        id: get-run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow "Terraform CI" \
            --branch ${{ github.head_ref }} \
            --status success \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Found CI Run ID: $RUN_ID"

  # Deploy to each environment in sequence
  # Each environment uses the reusable workflow and depends on the previous one
  deploy-dev:
    name: Deploy dev
    needs: [get-run-id]
    if: github.event.pull_request.merged == true
    uses: ./.github/workflows/deploy-environment.yml
    with:
      environment: dev
      terraform_version: ${{ vars.TF_VERSION }}
      ci_run_id: ${{ needs.get-run-id.outputs.run_id }}
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

  deploy-staging:
    name: Deploy staging
    needs: [get-run-id, deploy-dev]
    if: github.event.pull_request.merged == true
    uses: ./.github/workflows/deploy-environment.yml
    with:
      environment: staging
      terraform_version: ${{ vars.TF_VERSION }}
      ci_run_id: ${{ needs.get-run-id.outputs.run_id }}
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
