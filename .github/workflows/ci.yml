name: Terraform CI

on:
  pull_request:
    branches:
      - main

env:
  TF_LOG: INFO
  TF_INPUT: false
  TF_VERSION: ${{ vars.TF_VERSION }}
  ENVIRONMENTS: '["dev","staging","prodeast","prodwest"]'

jobs:
  # Setup job to output environments for matrix
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ env.ENVIRONMENTS }}
    steps:
      - name: Output environments
        run: echo "Environments - ${{ env.ENVIRONMENTS }}"

  # Format check
  format:
    name: Terraform Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

  # Validate configuration
  validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

  # TFLint
  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint --recursive

  # Trivy security scan
  trivy:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: .
          exit-code: 1
          severity: CRITICAL

  # Terraform Plan for all environments
  plan:
    name: Terraform Plan (${{ matrix.environment }})
    runs-on: ubuntu-latest
    needs: [setup, format, validate, tflint, trivy]
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJson(needs.setup.outputs.environments) }}
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -backend-config="./backends/${{ matrix.environment }}.hcl"

      - name: Terraform Plan
        run: terraform plan -var-file="./environments/${{ matrix.environment }}.tfvars" -out=tf.plan

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tf-plan-${{ matrix.environment }}-${{ github.run_id }}
          path: tf.plan
          retention-days: 5

      - name: Setup tf-summarize
        uses: kishaningithub/setup-tf-summarize@v2

      - name: Generate Plan Summary
        id: summary
        run: |
          terraform show -json tf.plan > plan.json
          tf-summarize -md plan.json > summary.md

      - name: Add Plan Summary to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');
            const body = `## Terraform Plan Summary - ${{ matrix.environment }}\n\n${summary}\n\n*Workflow Run ID: ${{ github.run_id }}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
